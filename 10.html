<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>บัญชีรายรับรายจ่าย</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f4f7fb;
      margin: 0;
      padding: 0;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    h2 {
      text-align: center;
      color: #333;
      margin-top: 30px;
      font-size: 28px;
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      background-color: #FAFAD2;
      border: 2px solid #ED01ED;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      width: 95%; 
    }
    .section-header {
      background-color: #4CAF50;
      color: white;
      padding: 12px 15px;
      border-radius: 20px;
      margin-bottom: 10px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section-header:hover { background-color: #45a049; }
    .section-header .arrow { transition: transform 0.3s; }
    .section-header.active .arrow { transform: rotate(90deg); }
    
    .section-header > span:first-child {
        flex: 1;
        text-align: center;
    }

    .header-account, .header-add-data, .header-actions, .header-summary {
        border: 3px solid #E97132;
    }

    .header-account { background-color: #0070C0; }
    .header-account:hover { background-color: #B5E6A2; }

    .header-add-data { background-color: #00B0F0; }
    .header-add-data:hover { background-color: #B5E6A2; }

    .header-actions { background-color: #00B050; }
    .header-actions:hover { background-color: #B5E6A2; }

    .header-summary { background-color: #ED01ED; }
    .header-summary:hover { background-color: #B5E6A2; }
    
    .section-content {
      display: none;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 20px;
      background-color: #f9f9f9;
      margin-bottom: 15px;
    }
    .section-content.active { display: block; }
    
    .sub-section-header {
      background-color: rgba(92, 107, 192, 0.6);
      margin-top: 20px;
    }
    .sub-section-header:hover {
      background-color: rgba(63, 81, 181, 0.75);
    }

    .sub-section-content {
        border: none;
        background-color: transparent;
        padding: 10px 0 0 0;
        margin-bottom: 0;
    }

    .entry-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    .entry-group { display: flex; flex-direction: column; }
    .button-group,
    .button-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin: 10px 0;
    }
    label {
      font-weight: bold;
      color: #333;
      font-size: 16px;
      margin-bottom: 5px;
      text-align: center;
    }
    select,
    input[type="text"],
    input[type="number"],
    input[type="date"] {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 20px;
      background-color: #f9f9f9;
      text-align: center;
    }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] { -moz-appearance: textfield; }
    .back-button,
    .file-button {
      font-size: 16px;
      padding: 12px 20px;
      border-radius: 20px;
      border: none;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      margin: 10px auto;
      display: block;
      width: 60%;
      max-width: 300px;
    }
    .back-button { background-color: #E97132; }
    .back-button:hover { background-color: #e64a19; }
    .file-button { background-color: #007bff; }
    .file-button:hover { background-color: #0056b3; }
    .button-group button,
    .button-container button {
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 50px;
      background-color: #4caf50;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .button-group button:hover,
    .button-container button:hover {
      background-color: #45a049;
      transform: translateY(-2px);
    }
    #recordTable {
      width: 100%;
      border-collapse: collapse;
      margin: 10px auto;
    }
    #recordTable th,
    #recordTable td {
      border: 1px solid #ccc;
      padding: 8px;
      line-height: 0.5;
      text-align: center;
      word-break: break-word;
    }
    #recordTable th { background-color: #f4f4f4; }
    #recordTable tr:nth-child(even) { background-color: #f9f9f9; }
    #recordTable tr:hover { background-color: #f1f1f1; }
    
    .summaryResult {
      font-size: clamp(12px, 2.2vw, 15px);
      font-weight: normal;
      color: blue;
      background-color: #FAFAD2;
      border: 3px solid #4CAF50;
      border-radius: 5px;
      padding: 5px;
      width: 100%;
      margin: 0;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      line-height: 0.5;
    }
    .summaryResult table td, .summaryResult table th {
        line-height: 0.5; 
    }

    .file-actions { display: flex; gap: 10px; align-items: center; }
    .action-button {
      padding: 10px 20px;
      height: 40px;
      min-width: 150px;
      border: none;
      border-radius: 20px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .file-button-wrapper button { background-color: #007bff; }
    .excel-button { background-color: #28a745; }
    .toast-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 24px;
        color: white;
        border-radius: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s, visibility 0.5s, transform 0.5s;
        transform: translateY(20px);
    }
    .toast-notification.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    .checkbox-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 20px;
        border: 1px solid #ced4da;
    }
    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 5px;
        justify-content: center;
    }
    .checkbox-item input {
        width: auto;
    }
    .summary-subsection {
        border-top: 1px solid #ccc;
        margin-top: 15px;
        padding-top: 15px;
    }
    .summary-subsection:first-child {
        border-top: none;
        margin-top: 0;
        padding-top: 0;
    }
    .summary-subsection-header {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
        font-size: 1.1em;
        color: #0056b3;
    }

    .modal-overlay {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      padding: 5px;
      overflow-y: auto;
    }

    .modal-content-container {
      background-color: transparent;
      padding: 0;
      border: none;
      box-shadow: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: auto 0;
      width: 100%; 
      max-width: 800px;
    }

    .modal-close-btn {
      background-color: #E97132;
      color: white;
      padding: 12px 30px;
      border: none;
      cursor: pointer;
      border-radius: 20px;
      font-size: 16px;
      margin-top: 10px;
      transition: background-color 0.3s;
    }
    .modal-close-btn:hover {
      background-color: #e64a19;
    }

    @media screen and (max-width: 600px) {
      .container {
        padding: 5px;
      }
      h2 {
        font-size: 24px;
      }
      .entry-form, .button-group, .button-container { 
        grid-template-columns: 1fr; 
      }

      .sub-section-content .button-group {
        grid-template-columns: repeat(3, 1fr);
        gap: 5px;
      }
      .sub-section-content .button-group button {
        padding: 10px 5px;
        font-size: 14px;
      }
      
      .button-group button, .button-container button { 
        padding: 14px; font-size: 16px; 
      }
      .file-actions {
        flex-direction: column;
        padding: 0 10px;
        align-items: stretch;
      }
      .file-actions button {
        width: 100%;
        max-width: none;
      }
      .back-button {
          width: 100%;
      }
    }
  </style>
</head>
<body>

<div style="text-align: center; margin-top: 5px;">
    <button class="back-button" onclick="window.location.href='https://juckmanphai.github.io/juck/01.html'" style="width: 600px; height: 45px; margin: 0 auto;">กลับสู่หน้าหลัก</button>
</div>
<div style="text-align: center; margin-top: 5px;">
    <div class="container">
        <div style="width: 100%; max-width: 600px; margin: 10px auto;">
            <div class="file-actions" style="display: flex; justify-content: center; gap: 10px;">
                <div class="file-button-wrapper" style="flex: 1; min-width: 0;">
                    <input type="file" id="fileInput" onchange="loadFromFile(event)" style="display: none;" accept=".json,application/json">
                    <button type="button" onclick="document.getElementById('fileInput').click()" 
                            class="action-button" 
                            style="width: 100%; height: 45px; padding: 10px; font-size: 16px; background-color: #196B24; color: #FFFFFF; border: 2px solid #EE0000; border-radius: 30px; cursor: pointer; margin: 0 auto;">
                        โหลดข้อมูล (แบบครั้งเดียว)
                    </button>
                </div>
            </div>

            <div id="dbConnector" style="text-align: center; margin-top: 10px; padding: 10px; background-color: #e3f2fd; border-radius: 10px; border: 1px solid #90caf9;">
                <p style="margin: 0 0 10px 0; font-weight: bold; color: #0d47a1;">
                    เชื่อมต่อฐานข้อมูลถาวร
                </p>
                <p id="dbStatus" style="font-size: 14px; color: #555; margin-bottom: 10px;">
                    สถานะ: ยังไม่ได้เชื่อมต่อ
                </p>
                <div class="button-container" style="margin: 0;">
                    <button onclick="connectToFileDb()" style="background-color: #1976d2;">เลือกไฟล์ฐานข้อมูล</button>
                    <button onclick="createNewFileDb()" style="background-color: #388e3c;">สร้างไฟล์ฐานข้อมูลใหม่</button>
                </div>
            </div>

            <div style="text-align: center; margin-top: 10px;">
                <h1 style="text-align: center; color: blue; font-size: 16px;">
                    ชื่อบัญชี - <span id="accountName"></span>
                </h1>
                <div class="section-header header-account" onclick="toggleSection('account-section')">
                    <span>เลือกและจัดการบัญชี</span>
                    <span class="arrow">▶</span>
                </div>
                <div id="account-section" class="section-content">
                    <label for="accountSelect">เลือกบัญชี:</label>
                    <select id="accountSelect" onchange="changeAccount()"></select>
                    
                    <div class="section-header sub-section-header" onclick="toggleSection('manage-account-submenu')">
                        <span>จัดการบัญชี</span>
                        <span class="arrow">▶</span>
                    </div>
                    <div id="manage-account-submenu" class="section-content sub-section-content">
                        <div class="button-group">
                            <button type="button" onclick="addAccount()" style="background-color: #28a745;">เพิ่มบช.ใหม่</button>
                            <button type="button" onclick="deleteAccount()" style="background-color: #dc3545;">ลบบช.</button>
                            <button type="button" onclick="editAccount()" style="background-color: #ffc107;">แก้ไขชื่อบช.</button>
                        </div>
                    </div>
                </div>

                <div class="section-header header-add-data" onclick="toggleSection('add-data-section')">
                    <span>เพิ่มข้อมูล</span>
                    <span class="arrow">▶</span>
                </div>
                <div id="add-data-section" class="section-content">
                    <div class="entry-form">
                        <div class="entry-group">
                            <label for="entryDate">วันที่ (วัน/เดือน/ปี)</label>
                            <input type="text" id="entryDate" placeholder="เช่น 10/11/2024">
                        </div>
                        <div class="entry-group">
                            <label for="entryTime">เวลา (HH.MM)</label>
                            <input type="text" id="entryTime" placeholder="เช่น 14.30" pattern="\d{1,2}\.\d{2}">
                        </div>
                    </div>
                    <div class="entry-group">
                        <label for="amount">จำนวนเงิน</label>
                        <input type="number" id="amount" required>
                    </div>
                    <div class="entry-group">
                        <label for="type">ประเภท</label>
                        <input list="typeList" id="type" required placeholder="เลือกหรือพิมพ์ประเภท" style="height: 40px;" onfocus="showAllTypes(this)" onblur="restoreType(this)">
                        <datalist id="typeList"></datalist>
                        
                        <div class="section-header sub-section-header" onclick="toggleSection('manage-types-submenu')" style="margin-top:10px;">
                            <span>จัดการประเภท</span>
                            <span class="arrow">▶</span>
                        </div>
                        <div id="manage-types-submenu" class="section-content sub-section-content">
                            <div class="button-group">
                                <button type="button" onclick="addNewType()" style="background-color: #2196F3;">เพิ่มประเภท</button>
                                <button type="button" onclick="deleteType()" style="background-color: #F44336;">ลบประเภท</button>
                                <button type="button" onclick="editType()" style="background-color: #FFC107;">แก้ไขประเภท</button>
                            </div>
                        </div>
                    </div>
                    <div class="entry-group">
                        <label for="description">รายละเอียด</label>
                        <input type="text" id="description" required>
                    </div>
                    
                    <div class="entry-group" id="multiAccountSelector" style="display: none; margin-top: 10px;">
                        <div class="section-header sub-section-header" onclick="toggleSection('multi-account-submenu')">
                            <span>เพิ่มรายการนี้ในบัญชีอื่นด้วย</span>
                            <span class="arrow">▶</span>
                        </div>
                        <div id="multi-account-submenu" class="section-content sub-section-content">
                            <div id="multiAccountCheckboxes" class="checkbox-container">
                            </div>
                        </div>
                    </div>

                    <div class="button-container" style="text-align: center; margin-top: 20px;">
                        <button type="button" onclick="addEntry()" style="background-color: #e91e63;">เพิ่มข้อมูล</button>
                    </div>
                </div>
                
                <div class="section-header header-actions" onclick="toggleSection('other-actions-section')">
                    <span>จัดการข้อมูล</span>
                    <span class="arrow">▶</span>
                </div>
                <div id="other-actions-section" class="section-content">
                    <div class="button-container" style="display: flex; gap: 10px; margin-top: 10px;">
                        <button onclick="toggleRecordsVisibility()" style="flex: 1; background-color: #607d8b;">แสดง/ซ่อนรายการ</button>
                    </div>
                    <div class="button-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                        <button type="button" onclick="saveData()" style="flex: 1; background-color: #17a2b8;">บันทึกข้อมูล</button>
                        <button type="button" onclick="exportAllDataToJson()" style="flex: 1; background-color: #0d47a1;">ส่งออกทุกบัญชี (ไฟล์)</button>
                        <button type="button" onclick="exportAccountToJson()" style="flex: 1; background-color: #9C27B0;">ส่งออกบัญชีที่เลือก</button>
                        <button type="button" onclick="exportToExcel()" style="flex: 1; background-color: #2E7D32; color: white;">
                            ส่งออก Excel
                        </button>
                    </div>
                </div>

                <div class="section-header header-summary" onclick="toggleSection('summary-main-section')">
                    <span>สรุปข้อมูล</span>
                    <span class="arrow">▶</span>
                </div>
                <div id="summary-main-section" class="section-content">
                    <div class="summary-subsection">
                        <div class="button-container" style="margin: 0;">
                            <button type="button" onclick="summarizeToday()" style="background-color: #ff9800; color: #FFFFFF;">สรุปวันนี้</button>
                        </div>
                    </div>
                    <div class="summary-subsection">
                        <label class="summary-subsection-header">สรุปวันที่เลือก</label>
                        <div class="entry-form" style="margin-bottom: 0;">
                            <div class="entry-group">
                                <label for="customDayMonth">วันที่ (วัน/เดือน/ปี):</label>
                                <input type="text" id="customDayMonth" placeholder="เช่น 10/11/2024">
                            </div>
                        </div>
                        <div class="button-container" style="text-align: center; margin-top: 10px;">
                            <button type="button" onclick="summarizeByDayMonth()" style="background-color: #03a9f4;">สรุปวันที่เลือก</button>
                        </div>
                    </div>
                    <div class="summary-subsection">
                        <label class="summary-subsection-header">สรุปวันที่ถึงวันที่</label>
                        <div class="entry-form" style="margin-bottom: 0;">
                            <div class="entry-group">
                                <label for="startDate">จากวันที่ (วัน/เดือน/ปี):</label>
                                <input type="text" id="startDate" placeholder="เช่น 10/11/2024">
                            </div>
                            <div class="entry-group">
                                <label for="endDate">ถึงวันที่ (วัน/เดือน/ปี):</label>
                                <input type="text" id="endDate" placeholder="เช่น 15/11/2024">
                            </div>
                        </div>
                        <div class="button-container" style="text-align: center; margin-top: 10px;">
                            <button type="button" onclick="summarize()" style="background-color: #009688;">สรุปวันที่ถึงวันที่</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<div id="detailsSection" style="display: none; margin-top: 20px; width: 100%; overflow-x: auto;">
  <table id="recordTable" style="min-width: 600px;">
    <thead>
      <tr style="background-color: #f2f2f2;">
        <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">วันเดือนปี</th>
        <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">เวลา</th>
        <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ประเภท</th>
        <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">รายละเอียด</th>
        <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">จำนวนเงิน</th>
        <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">การจัดการ</th>
      </tr>
    </thead>
    <tbody id="recordBody" style="font-size: 14px;"></tbody>
  </table>
</div>
</div>

<div id="summaryModal" class="modal-overlay">
  <div class="modal-content-container">
    <div id="modalBodyContent" class="summaryResult">
    </div>
    <button onclick="closeSummaryModal()" class="modal-close-btn">ปิดหน้าต่างนี้</button>
  </div>
</div>

<div id="toast" class="toast-notification"></div>

<script>
    // --- START: Global Variables & System Handles ---
    let fileHandle = null; // ตัวแปรสำหรับ File System Access API
    const accounts = [];
    let currentAccount = null;
    const records = [];
    let editingIndex = null;
    const accountTypes = new Map();
    let tempTypeValue = '';
    // --- END: Global Variables & System Handles ---


    // --- START: File System Access API & Data Persistence Logic ---

    async function connectToFileDb() {
        if (!window.showOpenFilePicker) {
            alert("เบราว์เซอร์ของคุณไม่รองรับฟังก์ชันนี้\nแนะนำให้ใช้ Google Chrome หรือ Microsoft Edge");
            return;
        }
        try {
            [fileHandle] = await window.showOpenFilePicker({
                types: [{
                    description: 'JSON Files',
                    accept: { 'application/json': ['.json'] },
                }],
            });
            await loadFromFileSystem();
            document.getElementById('dbStatus').textContent = `สถานะ: เชื่อมต่อกับไฟล์ "${fileHandle.name}"`;
            showToast(`✓ เชื่อมต่อกับไฟล์ ${fileHandle.name} สำเร็จ`, '#1976d2');
        } catch (err) {
            console.error('ผู้ใช้ยกเลิกการเลือกไฟล์ หรือเกิดข้อผิดพลาด:', err);
        }
    }

    async function createNewFileDb() {
        if (!window.showSaveFilePicker) {
            alert("เบราว์เซอร์ของคุณไม่รองรับฟังก์ชันนี้\nแนะนำให้ใช้ Google Chrome หรือ Microsoft Edge");
            return;
        }
        try {
            fileHandle = await window.showSaveFilePicker({
                suggestedName: 'my-account-database.json',
                types: [{
                    description: 'JSON Files',
                    accept: { 'application/json': ['.json'] },
                }],
            });
            const initialData = {
                accounts: ["บัญชีหลัก"],
                currentAccount: "บัญชีหลัก",
                records: [],
                accountTypes: [["บัญชีหลัก", { "รายรับ": ["ถูกหวย", "เติมทุน"], "รายจ่าย": ["ชื้อหวย", "โอนกำไร", "ชื้อกับข้าว"] }]]
            };
            const writable = await fileHandle.createWritable();
            await writable.write(JSON.stringify(initialData, null, 2));
            await writable.close();
            loadDataIntoApp(initialData);
            document.getElementById('dbStatus').textContent = `สถานะ: เชื่อมต่อกับไฟล์ "${fileHandle.name}"`;
            showToast(`✓ สร้างและเชื่อมต่อไฟล์ ${fileHandle.name} สำเร็จ`, '#388e3c');
        } catch (err) {
            console.error('ผู้ใช้ยกเลิกการสร้างไฟล์ หรือเกิดข้อผิดพลาด:', err);
        }
    }

    async function loadFromFileSystem() {
        if (!fileHandle) return;
        try {
            const file = await fileHandle.getFile();
            const content = await file.text();
            const data = JSON.parse(content);
            loadDataIntoApp(data);
        } catch (err) {
            console.error("เกิดข้อผิดพลาดในการอ่านไฟล์:", err);
            alert("ไม่สามารถอ่านข้อมูลจากไฟล์ที่เชื่อมต่อได้");
        }
    }

    async function saveToFileSystem() {
        if (!fileHandle) {
             // ถ้าไม่มีการเชื่อมต่อ จะไม่ทำอะไรจากฟังก์ชันนี้โดยตรง
             // ให้ผู้ใช้กดปุ่ม Export แทน
            showToast('ไม่ได้เชื่อมต่อไฟล์ถาวร บันทึกใน LocalStorage แทน', '#ff9800');
            return false; // ส่งสัญญาณว่าบันทึกไม่สำเร็จ
        }
        try {
            if (await fileHandle.queryPermission({ mode: 'readwrite' }) !== 'granted') {
                if (await fileHandle.requestPermission({ mode: 'readwrite' }) !== 'granted') {
                    alert("ไม่ได้รับอนุญาตให้บันทึกไฟล์");
                    return false;
                }
            }
            const dataToSave = {
                accounts: [...accounts],
                currentAccount: currentAccount,
                records: [...records],
                accountTypes: Array.from(accountTypes.entries())
            };
            const writable = await fileHandle.createWritable();
            await writable.write(JSON.stringify(dataToSave, null, 2));
            await writable.close();
            return true; // ส่งสัญญาณว่าบันทึกสำเร็จ
        } catch (err) {
            console.error("เกิดข้อผิดพลาดในการบันทึกไฟล์:", err);
            alert("ไม่สามารถบันทึกข้อมูลลงไฟล์ได้");
            return false;
        }
    }
    
    // **ฟังก์ชันศูนย์กลางการบันทึกข้อมูล**
    async function saveData(entryCategory = 'neutral') {
        const savedToFile = await saveToFileSystem();
        
        if (savedToFile) {
            // บันทึกลงไฟล์สำเร็จ
            showToast(`✓ บันทึกข้อมูลลงไฟล์ ${fileHandle.name} สำเร็จ`, '#1976d2');
        } else {
            // บันทึกลงไฟล์ไม่สำเร็จ (อาจจะไม่ได้เชื่อมต่อ) ให้บันทึกลง LocalStorage แทน
            const dataToSave = {
                accounts: [...accounts],
                currentAccount: currentAccount,
                records: [...records],
                accountTypes: Array.from(accountTypes.entries())
            };
            try {
                localStorage.setItem('accountData', JSON.stringify(dataToSave));
                // Toast สำหรับ LocalStorage จะแสดงก็ต่อเมื่อไม่ได้เชื่อมต่อไฟล์เท่านั้น
                if (!fileHandle) {
                    let toastColor = '#007bff';
                    if (entryCategory === 'income') toastColor = '#28a745';
                    else if (entryCategory === 'expense') toastColor = '#dc3545';
                    showToast('✓ บันทึกข้อมูลชั่วคราวสำเร็จ', toastColor);
                }
            } catch (error) {
                console.error("บันทึกข้อมูลไม่สำเร็จ:", error);
                alert("⚠️ เกิดข้อผิดพลาดในการบันทึกข้อมูล");
            }
        }
    }
    
    function loadFromLocal() {
        const data = localStorage.getItem('accountData');
        if (data) {
            try {
                const parsed = JSON.parse(data);
                loadDataIntoApp(parsed);
            } catch (error) {
                console.error("โหลดข้อมูลจาก LocalStorage ไม่สำเร็จ", error);
            }
        }
    }
    
    // ฟังก์ชัน Helper เพื่อโหลดข้อมูลและอัปเดต UI
    function loadDataIntoApp(data) {
        accounts.length = 0;
        records.length = 0;
        accountTypes.clear();

        accounts.push(...data.accounts || []);
        currentAccount = data.currentAccount || null;
        records.push(...data.records || []);
        if (data.accountTypes) {
            data.accountTypes.forEach(([account, types]) => {
                accountTypes.set(account, types);
            });
        }
        updateAccountSelect();
        if (currentAccount) {
            document.getElementById('accountSelect').value = currentAccount;
        }
        changeAccount();
    }

    // --- END: File System Access API & Data Persistence Logic ---


    // --- START: UI & Helper Functions ---

    function showToast(message, color = '#007bff') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.backgroundColor = color;
        toast.className = "toast-notification show";
        setTimeout(function(){ 
            toast.className = toast.className.replace("show", ""); 
        }, 3000);
    }

    function openSummaryModal(htmlContent) {
        document.getElementById('modalBodyContent').innerHTML = htmlContent;
        document.getElementById('summaryModal').style.display = 'flex';
    }

    function closeSummaryModal() {
        document.getElementById('summaryModal').style.display = 'none';
    }

    function toggleSection(sectionId) {
        const section = document.getElementById(sectionId);
        const header = section.previousElementSibling;
        section.classList.toggle('active');
        header.classList.toggle('active');
    }

    function showAllTypes(inputElement) {
        tempTypeValue = inputElement.value;
        inputElement.value = '';
    }

    function restoreType(inputElement) {
        if (inputElement.value === '') {
            inputElement.value = tempTypeValue;
        }
    }
    
    function toggleRecordsVisibility() {
        const detailsSection = document.getElementById('detailsSection');
        detailsSection.style.display = (detailsSection.style.display === 'none' || detailsSection.style.display === '') ? 'block' : 'none';
    }
    
    // --- END: UI & Helper Functions ---


    // --- START: Core Application Logic (Accounts, Types, Records) ---

    function updateMultiAccountSelector() {
        const selectorDiv = document.getElementById('multiAccountSelector');
        const checkboxesDiv = document.getElementById('multiAccountCheckboxes');
        checkboxesDiv.innerHTML = ''; 

        if (accounts.length > 1 && editingIndex === null) {
            selectorDiv.style.display = 'block';
            accounts.forEach(acc => {
                if (acc !== currentAccount) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'checkbox-item';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `acc-check-${acc}`;
                    checkbox.value = acc;
                    const label = document.createElement('label');
                    label.htmlFor = `acc-check-${acc}`;
                    label.textContent = acc;
                    itemDiv.appendChild(checkbox);
                    itemDiv.appendChild(label);
                    checkboxesDiv.appendChild(itemDiv);
                }
            });
        } else {
            selectorDiv.style.display = 'none';
        }
    }
    
    function initializeAccountTypes(accountName) {
        if (!accountTypes.has(accountName)) {
            accountTypes.set(accountName, {
                "รายรับ": ["ถูกหวย", "เติมทุน"],
                "รายจ่าย": ["ชื้อหวย", "โอนกำไร", "ชื้อกับข้าว"]
            });
        }
    }

    function updateTypeList() {
        const typeList = document.getElementById('typeList');
        if (!currentAccount) {
            typeList.innerHTML = '';
            return;
        }
        initializeAccountTypes(currentAccount);
        const types = accountTypes.get(currentAccount);
        typeList.innerHTML = '';
        [...types["รายจ่าย"], ...types["รายรับ"]].forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            typeList.appendChild(option);
        });
    }

    function addNewType() {
        if (!currentAccount) { alert("กรุณาเลือกบัญชีก่อนเพิ่มประเภท"); return; }
        initializeAccountTypes(currentAccount);
        const types = accountTypes.get(currentAccount);
        const category = prompt("เลือกประเภทที่จะเพิ่ม (รายรับ/รายจ่าย):");
        if (category !== "รายรับ" && category !== "รายจ่าย") { alert("กรุณากรอก 'รายรับ' หรือ 'รายจ่าย' เท่านั้น"); return; }
        const typeName = document.getElementById('type').value.trim();
        if (!typeName) { alert("กรุณากรอกชื่อประเภทในช่องประเภทก่อน"); return; }
        if (!types[category].includes(typeName)) {
            types[category].push(typeName);
            updateTypeList();
            alert(`เพิ่มประเภท "${typeName}" ในหมวด "${category}" เรียบร้อย`);
            saveData();
        } else {
            alert("ประเภทนี้มีอยู่แล้ว");
        }
    }
    
    function editType() {
        if (!currentAccount) { alert("กรุณาเลือกบัญชีก่อนแก้ไขประเภท"); return; }
        const types = accountTypes.get(currentAccount);
        const currentType = document.getElementById('type').value.trim();
        if (!currentType) { alert("กรุณาเลือกหรือพิมพ์ประเภทที่ต้องการแก้ไข"); return; }
        let foundCategory = Object.keys(types).find(cat => types[cat].includes(currentType));
        if (!foundCategory) { alert("ไม่พบประเภทที่ต้องการแก้ไข"); return; }
        const newName = prompt("กรุณากรอกชื่อประเภทใหม่:", currentType);
        if (newName && newName !== currentType) {
            const index = types[foundCategory].indexOf(currentType);
            types[foundCategory][index] = newName;
            records.forEach(record => {
                if (record.account === currentAccount && record.type === currentType) record.type = newName;
            });
            updateTypeList();
            document.getElementById('type').value = newName;
            alert("แก้ไขชื่อประเภทเรียบร้อย");
            saveData();
        }
    }

    function deleteType() {
        if (!currentAccount) { alert("กรุณาเลือกบัญชีก่อนลบประเภท"); return; }
        const types = accountTypes.get(currentAccount);
        const currentType = document.getElementById('type').value.trim();
        if (!currentType) { alert("กรุณาเลือกหรือพิมพ์ประเภทที่ต้องการลบ"); return; }
        let foundCategory = Object.keys(types).find(cat => types[cat].includes(currentType));
        if (!foundCategory) { alert("ไม่พบประเภทที่ต้องการลบ"); return; }
        if (confirm(`คุณแน่ใจว่าจะลบประเภท "${currentType}" หรือไม่?`)) {
            const index = types[foundCategory].indexOf(currentType);
            types[foundCategory].splice(index, 1);
            updateTypeList();
            document.getElementById('type').value = '';
            alert("ลบประเภทเรียบร้อย");
            saveData();
        }
    }

    function addAccount() {
        const accountName = prompt("กรุณากรอกชื่อบัญชีใหม่:");
        if (accountName && !accounts.includes(accountName)) {
            accounts.push(accountName);
            updateAccountSelect();
            updateMultiAccountSelector(); 
            alert("เพิ่มบัญชีสำเร็จ");
            saveData();
        } else {
            alert("ชื่อบัญชีซ้ำหรือกรอกข้อมูลไม่ถูกต้อง");
        }
    }

    function updateAccountSelect() {
        const accountSelect = document.getElementById('accountSelect');
        accountSelect.innerHTML = '<option value="">เลือกบัญชี</option>';
        accounts.forEach(account => {
            const option = document.createElement('option');
            option.value = account;
            option.textContent = account;
            accountSelect.appendChild(option);
        });
    }

    function changeAccount() {
        currentAccount = document.getElementById('accountSelect').value;
        document.getElementById('accountName').textContent = currentAccount || "N/A";
        updateTypeList();
        displayRecords();
        updateMultiAccountSelector(); 
    }

    function editAccount() {
        if (!currentAccount) { alert("กรุณาเลือกบัญชีที่ต้องการแก้ไข"); return; }
        const newAccountName = prompt("กรุณากรอกชื่อบัญชีใหม่:", currentAccount);
        if (newAccountName && newAccountName !== currentAccount && !accounts.includes(newAccountName)) {
            const index = accounts.indexOf(currentAccount);
            accounts[index] = newAccountName;
            records.forEach(r => { if (r.account === currentAccount) r.account = newAccountName; });
            if (accountTypes.has(currentAccount)) {
                accountTypes.set(newAccountName, accountTypes.get(currentAccount));
                accountTypes.delete(currentAccount);
            }
            currentAccount = newAccountName;
            updateAccountSelect();
            document.getElementById('accountName').textContent = currentAccount;
            changeAccount();
            alert("แก้ไขชื่อบัญชีเรียบร้อย");
            saveData();
        } else {
            alert("ชื่อบัญชีซ้ำหรือกรอกข้อมูลไม่ถูกต้อง");
        }
    }

    function deleteAccount() {
        if (!currentAccount) { alert("กรุณาเลือกบัญชีที่ต้องการลบ"); return; }
        if (confirm(`คุณแน่ใจว่าจะลบบัญชี "${currentAccount}" และข้อมูลทั้งหมดในบัญชีนี้หรือไม่?`)) {
            accounts.splice(accounts.indexOf(currentAccount), 1);
            accountTypes.delete(currentAccount);
            for (let i = records.length - 1; i >= 0; i--) {
                if (records[i].account === currentAccount) records.splice(i, 1);
            }
            currentAccount = null;
            document.getElementById('accountSelect').value = "";
            changeAccount();
            alert("ลบบัญชีเรียบร้อย");
            saveData();
        }
    }
    
    function addEntry() {
        const entryDateInput = document.getElementById('entryDate').value.trim();
        const entryTimeInput = document.getElementById('entryTime').value.trim();
        const typeText = document.getElementById('type').value.trim();
        const description = document.getElementById('description').value;
        const amount = parseFloat(document.getElementById('amount').value);

        if (!currentAccount) { alert("กรุณาเลือกบัญชีก่อนเพิ่มรายการ"); return; }
        if (!typeText || !description || isNaN(amount) || amount <= 0) { alert("กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง"); return; }
        
        let selectedDate;
        if (!entryDateInput) {
            selectedDate = new Date();
        } else {
            if (!/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(entryDateInput)) { alert("รูปแบบวันที่ไม่ถูกต้อง (วัน/เดือน/ปี)"); return; }
            const [day, month, year] = entryDateInput.split('/');
            selectedDate = new Date(year, month - 1, day);
        }
        let hours, minutes;
        if (!entryTimeInput) {
            const now = new Date();
            hours = String(now.getHours()).padStart(2, '0');
            minutes = String(now.getMinutes()).padStart(2, '0');
        } else {
            if (!/^\d{1,2}\.\d{2}$/.test(entryTimeInput)) { alert("รูปแบบเวลาไม่ถูกต้อง (HH.MM)"); return; }
            [hours, minutes] = entryTimeInput.split('.');
        }
        const dateTime = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')} ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        
        const types = accountTypes.get(currentAccount);
        let entryCategory = types["รายรับ"].includes(typeText) ? 'income' : 'expense';

        if (editingIndex !== null) {
            records[editingIndex] = { dateTime, type: typeText, description, amount, account: currentAccount };
            editingIndex = null;
        } else {
            records.push({ dateTime, type: typeText, description, amount, account: currentAccount });
            document.querySelectorAll('#multiAccountCheckboxes input:checked').forEach(checkbox => {
                records.push({ dateTime, type: typeText, description, amount, account: checkbox.value });
            });
        }
        
        displayRecords();
        document.getElementById('description').value = '';
        document.getElementById('amount').value = '';
        document.getElementById('entryDate').value = '';
        document.getElementById('entryTime').value = '';
        document.getElementById('type').value = '';
        document.querySelectorAll('#multiAccountCheckboxes input:checked').forEach(cb => { cb.checked = false; });
        updateMultiAccountSelector();
        saveData(entryCategory);
    }

    function displayRecords() {
        const recordBody = document.getElementById('recordBody');
        recordBody.innerHTML = "";
        if (!currentAccount) {
             recordBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">กรุณาเลือกบัญชี</td></tr>`;
             return;
        }
        const filteredRecords = records.filter(r => r.account === currentAccount).sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
        if (filteredRecords.length === 0) {
            recordBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">ไม่มีข้อมูล</td></tr>`;
            return;
        }
        filteredRecords.forEach((record) => {
            const originalIndex = records.indexOf(record);
            const dt = new Date(record.dateTime);
            const date = `${String(dt.getDate()).padStart(2, '0')}/${String(dt.getMonth() + 1).padStart(2, '0')}/${dt.getFullYear()}`;
            const time = `${String(dt.getHours()).padStart(2, '0')}.${String(dt.getMinutes()).padStart(2, '0')} น.`;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${date}</td><td>${time}</td><td>${record.type}</td>
                <td>${record.description}</td><td>${record.amount.toLocaleString()} บาท</td>
                <td>
                    <button onclick="editRecord(${originalIndex})">แก้ไข</button>
                    <button onclick="deleteRecord(${originalIndex})">ลบ</button>
                </td>`;
            recordBody.appendChild(row);
        });
    }

    function editRecord(index) {
        const record = records[index];
        const [datePart, timePart] = record.dateTime.split(' ');
        const [year, month, day] = datePart.split('-');
        const [hours, minutes] = timePart.split(':');
        document.getElementById('type').value = record.type;
        document.getElementById('description').value = record.description;
        document.getElementById('amount').value = record.amount;
        document.getElementById('entryDate').value = `${day}/${month}/${year}`;
        document.getElementById('entryTime').value = `${hours}.${minutes}`;
        editingIndex = index;
        updateMultiAccountSelector();
        toggleSection('add-data-section');
        document.getElementById('type').focus();
    }

    function deleteRecord(index) {
        if (confirm("คุณแน่ใจว่าจะลบรายการนี้หรือไม่?")) {
            records.splice(index, 1);
            displayRecords();
            saveData();
        }
    }

    // --- END: Core Application Logic ---


    // --- START: Data Summarization & Exporting ---

    function summarizeToday() {
        if (!currentAccount) { alert("กรุณาเลือกบัญชีก่อนสรุปข้อมูล"); return; }
        const today = new Date();
        document.getElementById('customDayMonth').value = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
        summarizeByDayMonth();
    }
    
    // (ฟังก์ชัน summarizeByDayMonth และ summarize ไม่ได้แก้ไข แต่เก็บไว้เพื่อความสมบูรณ์)
    function summarizeByDayMonth() {
        if (!records || !currentAccount) {
            alert("กรุณาเลือกบัญชีก่อนทำการสรุปข้อมูล");
            return;
        }
        const dayMonth = document.getElementById('customDayMonth').value.trim();
        if (!dayMonth || !/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dayMonth)) {
            alert("กรุณากรอกวัน/เดือน/ปี ค.ศ. ในรูปแบบ วัน/เดือน/ปี (เช่น 10/11/2024)");
            return;
        }
        const [day, month, year] = dayMonth.split('/');
        const selectedDate = new Date(year, month - 1, day);
        selectedDate.setHours(0, 0, 0, 0);
        const endOfDay = new Date(selectedDate);
        endOfDay.setHours(23, 59, 59, 999);
        const summary = {
            income: {}, expense: {}, totalIncome: 0, totalExpense: 0, incomeCount: 0, expenseCount: 0
        };
        const dayRecords = [];
        let totalBalance = 0;
        records.forEach(record => {
            if (!record.dateTime || typeof record.dateTime !== 'string') return;
            const [date, time] = record.dateTime.split(" ");
            const [recordYear, recordMonth, recordDay] = date.split("-");
            const recordDate = new Date(recordYear, recordMonth - 1, recordDay);
            if (record.account === currentAccount) {
                if (recordDate <= endOfDay) {
                    const types = accountTypes.get(currentAccount);
                    if (types["รายรับ"].includes(record.type)) {
                        totalBalance += record.amount;
                    } else if (types["รายจ่าย"].includes(record.type)) {
                        totalBalance -= record.amount;
                    }
                }
                const isSelectedDay = (recordDate >= selectedDate && recordDate <= endOfDay);
                if (!isSelectedDay) return;
                dayRecords.push(record);
                const types = accountTypes.get(currentAccount);
                if (types["รายรับ"].includes(record.type)) {
                    summary.totalIncome += record.amount;
                    summary.incomeCount++;
                    if (!summary.income[record.type]) {
                        summary.income[record.type] = { amount: 0, count: 0 };
                    }
                    summary.income[record.type].amount += record.amount;
                    summary.income[record.type].count++;
                } 
                else if (types["รายจ่าย"].includes(record.type)) {
                    summary.totalExpense += record.amount;
                    summary.expenseCount++;
                    if (!summary.expense[record.type]) {
                        summary.expense[record.type] = { amount: 0, count: 0 };
                    }
                    summary.expense[record.type].amount += record.amount;
                    summary.expense[record.type].count++;
                }
            }
        });
        dayRecords.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
        let incomeHTML = '';
        for (const type in summary.income) {
            incomeHTML += `<p>- ${type} : ${summary.income[type].count} ครั้ง เป็นเงิน ${summary.income[type].amount.toLocaleString()} บาท</p>`;
        }
        let expenseHTML = '';
        for (const type in summary.expense) {
            expenseHTML += `<p>- ${type} : ${summary.expense[type].count} ครั้ง เป็นเงิน ${summary.expense[type].amount.toLocaleString()} บาท</p>`;
        }
        let recordsHTML = '';
        if (dayRecords.length > 0) {
            recordsHTML = `
                <div style="margin-top: 20px;">
                    <h4 style="border-bottom: 1px solid #ddd; padding-bottom: 5px;">รายละเอียดวันที่เลือก : ${day}/${month}/${parseInt(year) + 543}</h4>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <thead><tr style="background-color: #f2f2f2;"><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">เวลา</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ประเภท</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">รายละเอียด</th><th style="padding: 8px; border: 1px solid #ddd; text-align: center;">จำนวนเงิน</th></tr></thead>
                        <tbody>
                            ${dayRecords.map(record => {
                                const [date, time] = record.dateTime.split(" ");
                                const [hours, minutes] = time.split(":");
                                const types = accountTypes.get(currentAccount);
                                const isIncome = types["รายรับ"].includes(record.type);
                                const color = isIncome ? "#4CAF50" : "#F44336";
                                return `<tr><td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${hours}.${minutes}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${record.type}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${record.description}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: ${color}; font-weight: bold;">${record.amount.toLocaleString()}</td></tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>`;
        }
        const thaiDate = new Date(selectedDate);
        const thaiMonth = thaiDate.toLocaleString('th-TH', { month: 'long' });
        const thaiDay = thaiDate.getDate();
        const thaiYear = thaiDate.getFullYear() + 543;
        const summaryDateTime = new Date().toLocaleString("th-TH", { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'}) + ' น.';
        const remarkInput = prompt("กรุณากรอกหมายเหตุ (ถ้าไม่กรอกจะใช้ 'No comment'):", "No comment") || "No comment";
        
        let summaryLineHTML;
        if (summary.totalIncome === 0 && summary.totalExpense === 0) {
            summaryLineHTML = `<p style="color: green; font-weight: bold;">สรุป : ไม่มีธุระกรรมการเงินวันนี้</p>`;
        } else {
            const netAmount = summary.totalIncome - summary.totalExpense;
            const netColor = netAmount >= 0 ? 'blue' : 'red';
            const netText = netAmount >= 0 ? 'รายได้มากกว่ารายจ่าย' : 'รายจ่ายมากกว่ารายได้';
            summaryLineHTML = `<p style="color: ${netColor}; font-weight: bold;">สรุป : ${netText} = ${Math.abs(netAmount).toLocaleString()} บาท</p>`;
        }
        
        const summaryHTML = `
            <p><strong>ชื่อบัญชี:</strong> ${currentAccount}</p>
            <p><strong>สรุปเมื่อวันที่ : </strong> ${summaryDateTime}</p>
            <p><strong>สรุปข้อมูลของวันที่ : </strong> ${thaiDay} ${thaiMonth} ${thaiYear}</p>
            <hr>
            <p><strong>รายรับ : </strong> ${summary.incomeCount} ครั้ง เป็นเงิน ${summary.totalIncome.toLocaleString()} บาท</p>${incomeHTML}
            <hr>
            <p><strong>รายจ่าย : </strong> ${summary.expenseCount} ครั้ง เป็นเงิน ${summary.totalExpense.toLocaleString()} บาท</p>${expenseHTML}
            <hr>
            ${summaryLineHTML}
            <p><span style="color: blue; font-size: 14px; font-weight: bold;">เงินในบัญชีถึงวันนี้มี =  </span><span style="color: ${totalBalance >= 0 ? 'green' : 'red'}; font-size: 16px; font-weight: bold;">${totalBalance.toLocaleString()}</span> บาท</p>
            <p>ข้อความเพิ่ม : <span style="color: orange;">${remarkInput}</span></p>
            ${recordsHTML}`;
        
        openSummaryModal(summaryHTML);
    }
    
    function summarize() {
        if (!records || !currentAccount) {
            alert("กรุณาเลือกบัญชีก่อนทำการสรุปข้อมูล");
            return;
        }
        const startDateInput = document.getElementById('startDate').value.trim();
        const endDateInput = document.getElementById('endDate').value.trim();
        if (!startDateInput || !endDateInput) {
            alert("กรุณาเลือกวันที่ให้ครบถ้วน");
            return;
        }
        if (!/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(startDateInput) || !/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(endDateInput)) {
            alert("กรุณากรอกวัน/เดือน/ปี ค.ศ. ในรูปแบบ วัน/เดือน/ปี (เช่น 10/11/2024)");
            return;
        }
        const [startDay, startMonth, startYear] = startDateInput.split('/');
        const [endDay, endMonth, endYear] = endDateInput.split('/');
        const startDate = new Date(startYear, startMonth - 1, startDay, 0, 0, 0, 0);
        const endDate = new Date(endYear, endMonth - 1, endDay, 23, 59, 59, 999);
        if (startDate > endDate) {
            alert("วันที่เริ่มต้นต้องน้อยกว่าหรือเท่ากับวันที่สิ้นสุด");
            return;
        }
        const daysDiff = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        const summary = { income: {}, expense: {}, totalIncome: 0, totalExpense: 0, incomeCount: 0, expenseCount: 0 };
        const transactionDays = new Set();
        let totalBalance = 0;

        records.forEach(record => {
            if (!record.dateTime || typeof record.dateTime !== 'string') return;
            const [date, time] = record.dateTime.split(" ");
            const [recordYear, recordMonth, recordDay] = date.split("-");
            const recordDate = new Date(recordYear, recordMonth - 1, recordDay);
            
            if (record.account === currentAccount) {
                if (recordDate <= endDate) {
                    const types = accountTypes.get(currentAccount);
                    if (types["รายรับ"].includes(record.type)) {
                        totalBalance += record.amount;
                    } else if (types["รายจ่าย"].includes(record.type)) {
                        totalBalance -= record.amount;
                    }
                }
                
                const isInPeriod = (recordDate >= startDate && recordDate <= endDate);
                if (!isInPeriod) return;
                
                transactionDays.add(date);
                
                const types = accountTypes.get(currentAccount);
                if (types["รายรับ"].includes(record.type)) {
                    summary.totalIncome += record.amount;
                    summary.incomeCount++;
                    if (!summary.income[record.type]) {
                        summary.income[record.type] = { amount: 0, count: 0 };
                    }
                    summary.income[record.type].amount += record.amount;
                    summary.income[record.type].count++;
                } 
                else if (types["รายจ่าย"].includes(record.type)) {
                    summary.totalExpense += record.amount;
                    summary.expenseCount++;
                    if (!summary.expense[record.type]) {
                        summary.expense[record.type] = { amount: 0, count: 0 };
                    }
                    summary.expense[record.type].amount += record.amount;
                    summary.expense[record.type].count++;
                }
            }
        });

        let transactionDaysSummaryHTML = '';
        const nonTransactionDays = daysDiff - transactionDays.size;
        if (transactionDays.size === 0) {
            transactionDaysSummaryHTML = `<p style="font-size: 16px; color: orange; font-weight: bold;">ช่วงเวลานี้ไม่มีธุรกรรม</p>`;
        } else if (transactionDays.size === daysDiff) {
            transactionDaysSummaryHTML = `<p style="font-size: 16px; color: green; font-weight: bold;">มีธุรกรรมทุกวันในช่วงเวลานี้</p>`;
        } else {
            transactionDaysSummaryHTML = `<p style="font-size: 16px; color: #333; font-weight: bold;">ทำธุรกรรม ${transactionDays.size} วัน, ไม่ได้ทำ ${nonTransactionDays} วัน</p>`;
        }

        let incomeHTML = '';
        for (const type in summary.income) {
            incomeHTML += `<p>- ${type} : ${summary.income[type].count} ครั้ง เป็นเงิน ${summary.income[type].amount.toLocaleString()} บาท</p>`;
        }
        let expenseHTML = '';
        for (const type in summary.expense) {
            expenseHTML += `<p>- ${type} : ${summary.expense[type].count} ครั้ง เป็นเงิน ${summary.expense[type].amount.toLocaleString()} บาท</p>`;
        }
        const thaiStartDate = new Date(startDate);
        const thaiStartMonth = thaiStartDate.toLocaleString('th-TH', { month: 'long' });
        const thaiStartDay = thaiStartDate.getDate();
        const thaiStartYear = thaiStartDate.getFullYear() + 543;
        const thaiEndDate = new Date(endDate);
        const thaiEndMonth = thaiEndDate.toLocaleString('th-TH', { month: 'long' });
        const thaiEndDay = thaiEndDate.getDate();
        const thaiEndYear = thaiEndDate.getFullYear() + 543;
        const summaryDateTime = new Date().toLocaleString("th-TH", { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'}) + ' น.';
        const remarkInput = prompt("กรุณากรอกหมายเหตุ (ถ้าไม่กรอกจะใช้ 'No comment'):", "No comment") || "No comment";
        let comparisonText = '';
        let comparisonColor = '';
        let differenceAmount = 0;
        if (summary.totalIncome > summary.totalExpense) {
            differenceAmount = summary.totalIncome - summary.totalExpense;
            comparisonText = `รายได้มากกว่ารายจ่าย = ${differenceAmount.toLocaleString()} บาท`;
            comparisonColor = 'blue';
        } else if (summary.totalIncome < summary.totalExpense) {
            differenceAmount = summary.totalExpense - summary.totalIncome;
            comparisonText = `รายจ่ายมากกว่ารายได้ = ${differenceAmount.toLocaleString()} บาท`;
            comparisonColor = 'red';
        } else {
            comparisonText = 'รายได้เท่ากับรายจ่าย';
            comparisonColor = 'black';
        }
        const summaryHTML = `
            <p><strong>ชื่อบัญชี : </strong> ${currentAccount}</p>
            <p><strong>สรุปเมื่อวันที่ : </strong> ${summaryDateTime}</p>
            <p><strong>สรุปวันที่ :</strong> ${thaiStartDay} ${thaiStartMonth} ${thaiStartYear} ถึง ${thaiEndDay} ${thaiEndMonth} ${thaiEndYear}</p>
            <p style="font-size: 16px; color: blue; font-weight: bold;">จำนวน ${daysDiff} วัน</p>
            ${transactionDaysSummaryHTML}
            <hr>
            <p><strong>รายรับทั้งหมด : </strong> ${summary.incomeCount} ครั้ง เป็นเงิน ${summary.totalIncome.toLocaleString()} บาท</p>
            ${incomeHTML}
            <hr>
            <p><strong>รายจ่ายทั้งหมด : </strong> ${summary.expenseCount} ครั้ง เป็นเงิน ${summary.totalExpense.toLocaleString()} บาท</p>
            ${expenseHTML}
            <hr>
            <p style="color: ${comparisonColor}; font-weight: bold; font-size: 16px;">สรุป : ${comparisonText}</p>
            <p><span style="color: blue; font-size: 14px; font-weight: bold;">เงินในบัญชีถึงวันนี้มี = </span><span style="color: ${totalBalance >= 0 ? 'green' : 'red'}; font-size: 16px; font-weight: bold;">${totalBalance.toLocaleString()}</span> บาท</p>
            <p>ข้อความเพิ่ม : <span style="color: orange;">${remarkInput}</span></p>
        `;
        openSummaryModal(summaryHTML);
    }
    
    function exportToExcel() {
        if (!currentAccount) { alert("กรุณาเลือกบัญชีก่อนส่งออกข้อมูล"); return; }
        const headerRow = ["วันที่", "เวลา", "ประเภท", "รายละเอียด", "จำนวนเงิน (บาท)"];
        let excelData = [ [`ชื่อบัญชี: ${currentAccount}`], headerRow ];
        const filteredRecords = records.filter(r => r.account === currentAccount).sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
        filteredRecords.forEach(r => {
            const dt = new Date(r.dateTime);
            const date = `${String(dt.getDate()).padStart(2, '0')}/${String(dt.getMonth() + 1).padStart(2, '0')}/${dt.getFullYear()}`;
            const time = `${String(dt.getHours()).padStart(2, '0')}.${String(dt.getMinutes()).padStart(2, '0')} น.`;
            excelData.push([date, time, r.type, r.description, r.amount]);
        });
        let csvContent = excelData.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(",")).join("\r\n");
        const now = new Date();
        const fileName = `บัญชี_${currentAccount}_${now.toISOString().slice(0,10)}.csv`;
        const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
    }

    function exportAllDataToJson() {
        const fileName = prompt("กรุณากรอกชื่อไฟล์ (ไม่ต้องใส่นามสกุล):", "all-accounts-backup");
        if (!fileName) return;
        
        const now = new Date();
        const fullFileName = `${fileName}_${now.toISOString().slice(0,10)}.json`;
        const data = { accounts, currentAccount, records, accountTypes: Array.from(accountTypes.entries()) };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fullFileName;
        a.click();
        URL.revokeObjectURL(a.href);
    }
    
    function exportAccountToJson() {
        if (!currentAccount) { alert("กรุณาเลือกบัญชีที่ต้องการส่งออก"); return; }
        const fileName = prompt(`กรุณากรอกชื่อไฟล์สำหรับบัญชี ${currentAccount}:`, currentAccount);
        if (!fileName) return;

        const now = new Date();
        const fullFileName = `${fileName}_${now.toISOString().slice(0,10)}.json`;
        const accountData = {
          accountName: currentAccount,
          records: records.filter(record => record.account === currentAccount),
          accountTypes: accountTypes.get(currentAccount)
        };
        const blob = new Blob([JSON.stringify(accountData, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fullFileName;
        a.click();
        URL.revokeObjectURL(a.href);
    }

    function loadFromFile(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data.accountName) { // ไฟล์จาก Export บัญชีเดียว
                    if (confirm(`พบข้อมูลบัญชี "${data.accountName}"\nต้องการนำเข้ารวมกับข้อมูลปัจจุบันหรือไม่?`)) {
                        if (!accounts.includes(data.accountName)) {
                            accounts.push(data.accountName);
                            accountTypes.set(data.accountName, data.accountTypes);
                        }
                        // ลบรายการเก่าของบัญชีนี้ (ถ้ามี) เพื่อแทนที่ด้วยข้อมูลใหม่
                        for (let i = records.length - 1; i >= 0; i--) {
                            if (records[i].account === data.accountName) records.splice(i, 1);
                        }
                        records.push(...data.records);
                        currentAccount = data.accountName;
                        changeAccount();
                        saveData();
                        alert(`นำเข้าบัญชี "${data.accountName}" สำเร็จ`);
                    }
                } else { // ไฟล์จาก Export ทุกบัญชี
                    if (confirm(`พบไฟล์สำรองข้อมูลทั้งหมด\nต้องการโหลดข้อมูลนี้ทับข้อมูลปัจจุบันทั้งหมดหรือไม่?`)) {
                        loadDataIntoApp(data);
                        saveData();
                        alert("โหลดข้อมูลทั้งหมดสำเร็จ");
                    }
                }
            } catch (error) {
                alert("ไฟล์ไม่ถูกต้องหรือเสียหาย: " + error.message);
            }
        };
        reader.readAsText(file);
        event.target.value = ''; // เคลียร์ค่า input เพื่อให้เลือกไฟล์เดิมซ้ำได้
    }

    // --- END: Data Summarization & Exporting ---


    // --- START: App Initialization ---

    window.onload = function () {
        document.getElementById('detailsSection').style.display = 'none';
        
        const dbConnectorDiv = document.getElementById('dbConnector');
        if (!window.showOpenFilePicker) {
            dbConnectorDiv.innerHTML = `
                <p style="margin: 0; font-weight: bold; color: #c62828;">
                    เบราว์เซอร์ไม่รองรับการเชื่อมต่อไฟล์ถาวร
                </p>
                <p style="font-size: 14px; color: #555; margin-bottom: 0;">
                    (แนะนำให้ใช้ Chrome/Edge)<br>
                    บนอุปกรณ์นี้ กรุณาใช้ปุ่ม "โหลดข้อมูล" และ "ส่งออก" เพื่อย้ายข้อมูล
                </p>`;
            dbConnectorDiv.style.backgroundColor = '#ffebee';
            dbConnectorDiv.style.border = '1px solid #e57373';
        }
        
        loadFromLocal();
        toggleSection('account-section');

        window.addEventListener('click', function(event) {
            if (event.target == document.getElementById('summaryModal')) {
                closeSummaryModal();
            }
        });
    };
    
    // --- END: App Initialization ---
</script>
</body>
</html>
